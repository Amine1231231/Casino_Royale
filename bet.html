<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Active Round</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .page { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden; }
    .section { padding: 20px; }
    .toolbar { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
    .actions { text-align: right; }
    .pill { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 16px; font-size: 0.9em; margin-top: 8px; }
    .btn { background: #ffd700; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #ffed4e; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: #666; font-size: 0.9em; }
    .list { list-style: none; padding: 0; margin: 0; }
    .match { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
    .name { font-weight: 500; }
    .chip { background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }
    .hidden { display: none; }
    .indicator { display: inline-block; width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; margin-left: 8px; animation: pulse 2s infinite; }
    .indicator.error { background: #f44336; animation: none; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="section">
      <div class="toolbar">
        <div>
          <h1>Live Active Round <span class="indicator" id="indicator"></span></h1>
          <p class="muted">Updates automatically from spreadsheet</p>
          <div id="roundTag" class="pill">Round —</div>
        </div>
        <div class="actions">
          <button id="refreshBtn" class="btn">Refresh</button>
          <div class="muted" id="statusMsg"></div>
          <div class="muted" id="lastUpdate"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <ul id="matchList" class="list"></ul>
      <p id="emptyState" class="muted hidden">No active round selected.</p>
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbxMUkU2r0BzeL4xwAhYRgLUbqYEaysj8wMr0VU-UguYqCCb_95jF3JmhH8DgiE3zLxIAQ/exec";
    
    const roundTag = document.getElementById('roundTag');
    const list = document.getElementById('matchList');
    const empty = document.getElementById('emptyState');
    const statusMsg = document.getElementById('statusMsg');
    const lastUpdate = document.getElementById('lastUpdate');
    const indicator = document.getElementById('indicator');

    function setStatus(text, isError = false) {
      statusMsg.textContent = text || '';
      indicator.classList.toggle('error', isError);
    }

    function renderMatches(round, matches) {
      console.log('Rendering:', {round, matches}); // Debug log
      
      roundTag.textContent = round ? `Round ${round}` : 'Round —';
      
      if (!matches || matches.length === 0) { 
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return; 
      }
      
      empty.classList.add('hidden');
      list.innerHTML = matches.map(m => 
        `<li class="match">
          <span class="name">${m}</span>
          <span class="chip">Open</span>
        </li>`
      ).join('');
    }

    async function loadData() {
      try {
        setStatus('Loading...');
        const url = API_BASE + "?path=activeRound&t=" + Date.now();
        const res = await fetch(url);
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        console.log('API Response:', data); // Debug log
        
        if (data?.ok) {
          renderMatches(data.round, data.matches || []);
          setStatus(data.round ? `Round ${data.round} loaded` : 'No active round');
          lastUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        } else {
          throw new Error(data.error || 'Invalid response');
        }
      } catch (err) {
        console.error('Error:', err);
        setStatus(`Error: ${err.message}`, true);
        renderMatches(null, []);
      }
    }

    // Load on start and refresh every 5 seconds
    loadData();
    setInterval(loadData, 5000);
    
    document.getElementById('refreshBtn').addEventListener('click', loadData);
  </script>
</body>
</html>
