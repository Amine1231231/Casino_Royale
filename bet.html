<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>T9imra Mli7a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
</head>
<body>
  <main class="page">
    <header class="section">
      <div class="toolbar">
        <div>
          <h1>T9imra Mli7a</h1>
          <p class="muted">Updates automatically from spreadsheet</p>
          <div id="roundTag" class="pill">Round —</div>
        </div>
        <div class="actions">
          <button id="refreshBtn" class="btn btn-gold"><span class="btn-icon"></span>Refresh</button>
          <div class="muted" id="statusMsg"></div>
          <div class="muted" id="lastUpdate"></div>
        </div>
      </div>
    </header>

    <section class="section" id="matchesSection">
      <ul id="matchList" class="list"></ul>
      <p id="emptyState" class="muted hidden">No active round selected.</p>
    </section>

    <section class="section hidden" id="flashcardSection" aria-hidden="true">
      <div class="toolbar" style="align-items:center;">
        <h2 style="margin:0">Bet Options • <span id="matchTitle" class="pill">Match —</span></h2>
        <div class="actions"><button id="backBtn" class="btn">← Back to matches</button></div>
      </div>
      <div id="flashcards" class="cards"></div>
    </section>
  </main>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyG5WGA1_AASu0ycs0GS2Kc_SOqz0nuxdmCXNtXY3T-BiOh4Kw2yfgcyjrINRC5kn-7tw/exec";
    const $ = id => document.getElementById(id);
    const el = {
      roundTag: $('roundTag'), matchList: $('matchList'), empty: $('emptyState'),
      status: $('statusMsg'), lastUpdate: $('lastUpdate'),
      btn: $('refreshBtn'), matchTitle: $('matchTitle'),
      matchesSec: $('matchesSection'), cardsSec: $('flashcardSection'),
      cardsHost: $('flashcards'), backBtn: $('backBtn')
    };

    let LATEST_MATCHES = [], CURRENT_MATCH = '', CURRENT_MATCH_PLAYERS = [];

    const playersFrom = (matches=[]) => {
      const s = new Set();
      matches.forEach(line=>{
        const [a,b]=String(line).split(/\s+vs\s+/i).map(x=>x?.trim()).filter(Boolean);
        if(a)s.add(a); if(b)s.add(b);
      });
      return [...s].sort((x,y)=>x.localeCompare(y,undefined,{sensitivity:'base'}));
    };

    function renderMatches(round, matches) {
      el.roundTag.textContent = round ? `Round ${round}` : 'Round —';
      if (!matches?.length) { el.matchList.innerHTML=''; el.empty.classList.remove('hidden'); return; }
      el.empty.classList.add('hidden');
      el.matchList.innerHTML = matches.map(m =>
        `<li class="match" onclick="handleMatchClick('${m.replace(/'/g,"\\'")}')">
           <span class="name">${m}</span><span class="meta"><span class="chip blue">Open</span></span>
         </li>`).join('');
    }

    async function loadData() {
      try {
        el.status.textContent = 'Loading…';
        const r = await fetch(`${API_BASE}?path=activeRound&t=${Date.now()}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        if (!d?.ok) throw new Error(d?.error || 'Invalid response');
        renderMatches(d.round, d.matches || []);
        LATEST_MATCHES = Array.isArray(d.matches) ? d.matches.slice() : [];
        el.status.textContent = d.round ? `Round ${d.round} loaded` : 'No active round';
        el.lastUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        el.status.textContent = `Error: ${e.message}`;
        renderMatches(null, []);
      }
    }

    function renderFlashcards(playersAll=[]) {
      const [p1,p2] = CURRENT_MATCH_PLAYERS;
      const opt = a => a.map(x=>`<option value="${x.replace(/"/g,'&quot;')}">${x}</option>`).join('');
      const scoreOpts = opt(["1-0","2-0","3-0","2-1","3-1","3-2"]);
      const playerOpts = opt(playersAll);

      el.cardsHost.innerHTML = `
        <!-- Card 1 -->
        <article class="card" tabindex="0">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">Who are you?</div></div>
            <div class="card__face card__face--back"><div class="card__content">
              <select id="playerSelect" class="card-select">
                <option value="" disabled selected>Select your name…</option>${playerOpts}
              </select>
            </div></div>
          </div>
        </article>
        <!-- Card 2 -->
        <article class="card" tabindex="0">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">How much you betting?</div></div>
            <div class="card__face card__face--back"><div class="card__content">
              <div class="stack">
                <input id="fundsDisplay" class="card-input" type="text" placeholder="Available: —" disabled />
                <input id="stakeInput" class="card-input" type="number" min="0" step="1" placeholder="Enter stake…" />
              </div>
            </div></div>
          </div>
        </article>
        <!-- Card 3 -->
        <article class="card" tabindex="0">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">Who wins?</div></div>
            <div class="card__face card__face--back"><div class="card__content">
              <label class="choice"><input type="checkbox" class="winnerCheck" value="${(p1||'').replace(/"/g,'&quot;')}"> ${p1||'Player A'}</label>
              <label class="choice"><input type="checkbox" class="winnerCheck" value="${(p2||'').replace(/"/g,'&quot;')}"> ${p2||'Player B'}</label>
            </div></div>
          </div>
        </article>
        <!-- Card 4 -->
        <article class="card" tabindex="0">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">Score?</div></div>
            <div class="card__face card__face--back"><div class="card__content">
              <select id="scoreSelect" class="card-select">
                <option value="" disabled selected>Select score…</option>${scoreOpts}
              </select>
            </div></div>
          </div>
        </article>
        <!-- Card 5..9 placeholders (unchanged) -->
        ${[
          ["First spell cast","Predict the spell type"],
          ["First building?","Inferno/Tesla/Cannon?"],
          ["Lead at 1:00","A leading by ≥2 elixir?"],
          ["Overtime outcome","Ends in OT or before?"],
          ["Opening card","Cycle vs. Heavy?"]
        ].map(([f,b])=>`
          <article class="card" tabindex="0">
            <div class="card__inner" role="button" aria-pressed="false">
              <div class="card__face card__face--front"><div class="card__content">${f}</div></div>
              <div class="card__face card__face--back"><div class="card__content">${b}</div></div>
            </div>
          </article>`).join('')}
      `;

      // guarded flip
      const host = el.cardsHost;
      host.onclick = e => {
        if (e.target.closest('input,select,textarea,button,label')) return;
        const face = e.target.closest('.card__face'); if (!face) return;
        const inner = face.closest('.card__inner'); if (!inner) return;
        const flip = face.classList.contains('card__face--front');
        inner.classList.toggle('is-flipped', flip ? true : false);
        if (!flip) inner.classList.remove('is-flipped');
        inner.setAttribute('aria-pressed', inner.classList.contains('is-flipped'));
      };
      host.onkeydown = e => {
        if (!['Enter',' '].includes(e.key)) return;
        const a = document.activeElement;
        if (a && ['INPUT','SELECT','TEXTAREA','BUTTON'].includes(a.tagName)) return;
        const inner = e.target.closest('.card')?.querySelector('.card__inner'); if (!inner) return;
        e.preventDefault();
        const to = !inner.classList.contains('is-flipped');
        inner.classList.toggle('is-flipped', to);
        inner.setAttribute('aria-pressed', to);
      };
      // single-select checkboxes
      const winners = host.querySelectorAll('.winnerCheck');
      winners.forEach(cb=>cb.addEventListener('change',ev=>{
        if(!ev.target.checked) return; winners.forEach(o=>{ if(o!==ev.target) o.checked=false; });
      }));
    }

    function handleMatchClick(matchName) {
      CURRENT_MATCH = matchName || '';
      const ab = String(CURRENT_MATCH).split(/\s+vs\s+/i).map(s=>s?.trim()).filter(Boolean);
      CURRENT_MATCH_PLAYERS = [ab[0]||'Player A', ab[1]||'Player B'];
      el.matchTitle.textContent = CURRENT_MATCH || 'Match —';
      renderFlashcards(playersFrom(LATEST_MATCHES));
      el.matchesSec.classList.add('hidden');
      el.cardsSec.classList.remove('hidden');
      el.cardsSec.setAttribute('aria-hidden','false');
      el.cardsSec.scrollIntoView({behavior:'smooth',block:'start'});
    }
    window.handleMatchClick = handleMatchClick;

    el.backBtn.addEventListener('click', () => {
      el.cardsSec.classList.add('hidden');
      el.cardsSec.setAttribute('aria-hidden','true');
      el.matchesSec.classList.remove('hidden');
      el.matchesSec.scrollIntoView({behavior:'smooth',block:'start'});
    });

    loadData();
    el.btn.addEventListener('click', loadData);
  </script>
</body>
</html>
