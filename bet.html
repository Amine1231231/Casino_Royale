<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>T9imra Mli7a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
</head>
<body>
  <main class="page">
    <header class="section">
      <div class="toolbar">
        <div>
          <h1>T9imra Mli7a</h1>
          <p class="muted">Updates automatically from spreadsheet</p>
          <div id="roundTag" class="pill">Round —</div>
        </div>
        <div class="actions">
          <button id="refreshBtn" class="btn btn-gold"><span class="btn-icon"></span>Refresh</button>
          <div class="muted" id="statusMsg"></div>
          <div class="muted" id="lastUpdate"></div>
        </div>
      </div>
    </header>

    <!-- Matches -->
    <section class="section" id="matchesSection">
      <ul id="matchList" class="list"></ul>
      <p id="emptyState" class="muted hidden">No active round selected.</p>
    </section>

    <!-- Flashcards -->
    <section class="section hidden" id="flashcardSection" aria-hidden="true">
      <div class="toolbar" style="align-items:center;">
        <h2 style="margin:0">Bet Options • <span id="matchTitle" class="pill">Match —</span></h2>
        <div class="actions"><button id="backBtn" class="btn btn-green">Confirm</button></div>
      </div>
      <div id="flashcards" class="cards"></div>
    </section>
  </main>

  <!-- Fullscreen Cards Browser Modal -->
  <div id="cardsModal" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop" id="cardsModalBackdrop"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="cardsModalTitle">
      <header class="modal__header">
        <h3 id="cardsModalTitle">Player’s cards <span id="deckCount" class="muted"></span></h3>
        <button id="cardsModalClose" class="btn">✕</button>
      </header>
      <div class="modal__controls">
        <input id="cardSearch" class="card-input" placeholder="Search cards (EN / FR)…" />
        <div class="chips">
          <button class="chip toggle" data-sort="elixir" id="sortElixir">Elixir</button>
          <button class="chip toggle" data-sort="type" id="sortType">Type</button>
        </div>
      </div>
      <div id="cardsGrid" class="grid-cards"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzdSl7ur0ZXf1pSyuWSBFJYmHbVGKDZiynaH-MbGk0Sq9LjgJvHRS9L8PplNUOFGN1HeA/exec";
    const $ = id => document.getElementById(id);
    const el = {
      roundTag: $('roundTag'), matchList: $('matchList'), empty: $('emptyState'),
      status: $('statusMsg'), lastUpdate: $('lastUpdate'), btn: $('refreshBtn'),
      matchesSec: $('matchesSection'), cardsSec: $('flashcardSection'), matchTitle: $('matchTitle'),
      cardsHost: $('flashcards'), backBtn: $('backBtn'),
      modal: $('cardsModal'), modalBackdrop: $('cardsModalBackdrop'), modalClose: $('cardsModalClose'),
      modalTitle: $('cardsModalTitle'), cardSearch: $('cardSearch'),
      sortElixir: $('sortElixir'), sortType: $('sortType'), cardsGrid: $('cardsGrid'),
      deckCount: $('deckCount')
    };
    const slug = s => String(s||'').toLowerCase().normalize('NFKD')
      .replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const cardId = c => String(
      c.id ?? (c.name_en ? `en-${slug(c.name_en)}` :
               c.name_fr ? `fr-${slug(c.name_fr)}` : `card-${Math.random().toString(36).slice(2)}`)
    );

    let LATEST_MATCHES = [], CURRENT_MATCH = '', CURRENT_MATCH_PLAYERS = [];
    let CARDS_DB = [], ACTIVE_SORT = ''; // '', 'elixir', 'type'
    const norm = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'');

    // --- NEW: per-player selections (max 8) ---
    const MAX_DECK = 8;
    let CURRENT_PLAYER_IN_MODAL = '';
    const SELECTED_CARDS = new Map(); // playerName -> Set(cardId)
    const getSel = (player) => {
      if (!SELECTED_CARDS.has(player)) SELECTED_CARDS.set(player, new Set());
      return SELECTED_CARDS.get(player);
    };
    function updateDeckCount(){
      const size = getSel(CURRENT_PLAYER_IN_MODAL).size;
      if (el.deckCount) el.deckCount.textContent = `(${size}/${MAX_DECK})`;
    }

    // ---------- Data loaders ----------
    async function loadCardsDB(){
      const url = 'assets/cards.json?v=' + Date.now();
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Fetch ${url} → HTTP ${res.status}`);
        const data = await res.json();
        CARDS_DB = Array.isArray(data) ? data : [];
      } catch (e) {
        console.error('cards.json failed:', e);
        CARDS_DB = [];
      }
    }
    async function loadData() {
      try {
        el.status.textContent = 'Loading…';
        const r = await fetch(`${API_BASE}?path=activeRound&t=${Date.now()}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        if (!d?.ok) throw new Error(d?.error || 'Invalid response');
        renderMatches(d.round, d.matches || []);
        LATEST_MATCHES = Array.isArray(d.matches) ? d.matches.slice() : [];
        el.status.textContent = d.round ? `Round ${d.round} loaded` : 'No active round';
        el.lastUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        el.status.textContent = `Error: ${e.message}`; renderMatches(null, []);
      }
    }

    async function saveOneLine(line){
      const url = `${API_BASE}?path=saveBet`;   // use your saveBet path
      const body = new URLSearchParams({ line }); // simple request => no preflight

  const res = await fetch(url, { method: 'POST', body }); // no headers
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (!data?.ok) throw new Error(data?.error || 'Save failed');
  return data;
}

function readVal(sel){ return (sel && sel.value != null && sel.value !== '—') ? String(sel.value).trim() : ''; }
function readChecked(name){ const n = document.querySelector(`input[name="${name}"]:checked`); return n ? n.value : ''; }

    // ---------- Matches ----------
    function renderMatches(round, matches) {
      el.roundTag.textContent = round ? `Round ${round}` : 'Round —';
      if (!matches?.length) { el.matchList.innerHTML=''; el.empty.classList.remove('hidden'); return; }
      el.empty.classList.add('hidden');
      el.matchList.innerHTML = matches.map(m =>
        `<li class="match" onclick="handleMatchClick('${m.replace(/'/g,"\\'")}')">
           <span class="name">${m}</span><span class="meta"><span class="chip blue">Open</span></span>
         </li>`).join('');
    }
    const playersFrom = (matches=[]) => {
      const s=new Set();
      matches.forEach(line=>{
        const [a,b]=String(line).split(/\s+vs\s+/i).map(x=>x?.trim()).filter(Boolean);
        if(a)s.add(a); if(b)s.add(b);
      });
      return [...s].sort((x,y)=>x.localeCompare(y,undefined,{sensitivity:'base'}));
    };

    function handleMatchClick(matchName) {
      CURRENT_MATCH = matchName || '';
      const ab = String(CURRENT_MATCH).split(/\s+vs\s+/i).map(s=>s?.trim()).filter(Boolean);
      CURRENT_MATCH_PLAYERS = [ab[0]||'Player A', ab[1]||'Player B'];
      el.matchTitle.textContent = CURRENT_MATCH || 'Match —';
      renderFlashcards(playersFrom(LATEST_MATCHES));
      el.matchesSec.classList.add('hidden'); el.cardsSec.classList.remove('hidden');
      el.cardsSec.setAttribute('aria-hidden','false'); el.cardsSec.scrollIntoView({behavior:'smooth',block:'start'});
    }
    window.handleMatchClick = handleMatchClick;

el.backBtn.addEventListener('click', async () => {
  // Card 1 & 2 (required)
  const player = readVal(document.getElementById('playerSelect'));     // Card 1
  const stake  = readVal(document.getElementById('stakeInput'));       // Card 2

  // If either missing → just go back to matches (no save)
  if (!player || !stake) {
    el.cardsSec.classList.add('hidden');
    el.cardsSec.setAttribute('aria-hidden','true');
    el.matchesSec.classList.remove('hidden');
    el.matchesSec.scrollIntoView({behavior:'smooth', block:'start'});
    return;
  }

  // The two actual player names from the match
  const [p1, p2] = CURRENT_MATCH_PLAYERS;

  // Other answers (blank if not set)
  const winner = (() => {
    const w = el.cardsHost.querySelector('.winnerCheck:checked');
    return w ? w.value : '';
  })();
  const score   = readVal(document.getElementById('scoreSelect'));
  const ot      = readChecked('ot');
  const minute  = readVal(document.getElementById('minuteSelect'));
  const second  = readVal(document.getElementById('secondSelect'));
  const towers1 = readVal(document.getElementById('towersP1'));
  const towers2 = readVal(document.getElementById('towersP2'));
  const spells1 = readVal(document.getElementById('spellsP1'));
  const builds1 = readVal(document.getElementById('buildingsP1'));
  const spells2 = readVal(document.getElementById('spellsP2'));
  const builds2 = readVal(document.getElementById('buildingsP2'));

  // Multi-answer: selected cards per player (comma-joined, empty if none)
  const sel1 = (SELECTED_CARDS.get(p1) ? [...SELECTED_CARDS.get(p1)] : []).join(',');
  const sel2 = (SELECTED_CARDS.get(p2) ? [...SELECTED_CARDS.get(p2)] : []).join(',');

  // Build the one-liner: {roundX/p1vp2/ans1/ans2/...}
  const roundNum = (el.roundTag.textContent.match(/\d+/)||[''])[0] || '';
  const matchKey = `${p1}v${p2}`.replace(/\s+/g,''); // “nameA v nameB” → “nameAvnameB”
  const answers = [
    player,           // ans1
    stake,            // ans2
    winner,           // ans3
    score,            // ans4
    ot,               // ans5
    minute,           // ans6
    second,           // ans7
    sel1,             // ans8  (P1 selected cards)
    sel2,             // ans9  (P2 selected cards)
    towers1,          // ans10
    towers2,          // ans11
    spells1,          // ans12
    builds1,          // ans13
    spells2,          // ans14
    builds2           // ans15
  ];
  const oneLine = `{round${roundNum}/${matchKey}/${answers.join('/')}}`;

  // Disable button during save
  el.backBtn.disabled = true;
  el.backBtn.classList.add('loading');

  // Try save; if backend isn’t ready, we at least log it.
  const ok = await saveOneLine(oneLine);
  if (!ok) console.log('One-line (fallback):', oneLine);

  // Return to matches either way
  el.backBtn.disabled = false;
  el.backBtn.classList.remove('loading');

  el.cardsSec.classList.add('hidden');
  el.cardsSec.setAttribute('aria-hidden','true');
  el.matchesSec.classList.remove('hidden');
  el.matchesSec.scrollIntoView({behavior:'smooth', block:'start'});

  // Optional status message
  el.status.textContent = ok ? 'Bet saved.' : 'Could not save (logged in console).';
});

    // ---------- Flashcards (1–9) ----------
    function renderFlashcards(playersAll=[]) {
      const [p1,p2] = CURRENT_MATCH_PLAYERS;
      const opt = a => a.map(x=>`<option value="${x.replace(/"/g,'&quot;')}">${x}</option>`).join('');
      const scoreOpts = opt(["1-0","2-0","3-0","2-1","3-1","3-2"]);
      const playerOpts = opt(playersAll);
      const secOpts = Array.from({length:60},(_,i)=>String(i).padStart(2,'0')).map(s=>`<option>${s}</option>`).join('');

      el.cardsHost.innerHTML = `
        <!-- 1 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">Who are you?</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <select id="playerSelect" class="card-select">
              <option value="" disabled selected>Select your name…</option>${playerOpts}
            </select>
          </div></div></div></article>

        <!-- 2 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">How much you betting?</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <div class="stack">
              <input id="fundsDisplay" class="card-input" type="text" placeholder="Available: —" disabled />
              <input id="stakeInput" class="card-input" type="number" min="0" step="1" placeholder="Enter stake…" />
            </div>
          </div></div></div></article>

        <!-- 3 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">Who wins?</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <label class="choice"><input type="checkbox" class="winnerCheck" value="${(p1||'').replace(/"/g,'&quot;')}"> ${p1||'Player A'}</label>
            <label class="choice"><input type="checkbox" class="winnerCheck" value="${(p2||'').replace(/"/g,'&quot;')}"> ${p2||'Player B'}</label>
          </div></div></div></article>

        <!-- 4 -->
        <article class="card" tabindex="0">
        <div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Towers for ${p1||'P1'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select id="towersP1"><option disabled selected>—</option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        <select id="towersP1">...</select>
        </div></div></div></article>

        <!-- 4 (bis) -->
        <article class="card" tabindex="0">
        <div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Towers for ${p2||'P2'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select id="towersP2"><option disabled selected>—</option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        <select id="towersP2">...</select>
        </div></div></div></article>

        <!-- 5 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">Overtime?</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <label class="choice"><input type="radio" name="ot" value="Yes"> Yes</label>
            <label class="choice"><input type="radio" name="ot" value="No"> No</label>
          </div></div></div></article>

        <!-- 6 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">Minute</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <select id="minuteSelect" class="card-select">
              <option value="" disabled selected>Select minute…</option>
              <option>2</option><option>1</option><option>0</option>
              <option>2 (OT)</option><option>1 (OT)</option><option>0 (OT)</option>
            </select>
          </div></div></div></article>

        <!-- 7 -->
        <article class="card" tabindex="0"><div class="card__inner" role="button" aria-pressed="false">
          <div class="card__face card__face--front"><div class="card__content">Second</div></div>
          <div class="card__face card__face--back"><div class="card__content">
            <select id="secondSelect" class="card-select">
              <option value="" disabled selected>Select second…</option>${secOpts}
            </select>
          </div></div></div></article>

        <!-- 8 -->
        <article class="card" tabindex="0" data-player="${(p1||'').replace(/"/g,'&quot;')}">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">${p1||'Player A'}’s cards</div></div>
            <div class="card__face card__face--back"><div class="card__content">Tap to browse ${p1||'Player A'}’s cards</div></div>
          </div>
        </article>

        <!-- 8 (bis1) -->
        <article class="card"><div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Spells ${p1||'P1'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select>${Array.from({length:9},(_,i)=>`<option>${i}</option>`).join('')}</select>
        <select id="spellsP1">...</select>
        </div></div>
        </div></article>

        <!-- 8 (bis2) -->
        <article class="card"><div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Buildings ${p1||'P1'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select>${Array.from({length:9},(_,i)=>`<option>${i}</option>`).join('')}</select>
        <select id="buildingsP1">...</select>
        </div></div>
        </div></article>

        <!-- 9 -->
        <article class="card" tabindex="0" data-player="${(p2||'').replace(/"/g,'&quot;')}">
          <div class="card__inner" role="button" aria-pressed="false">
            <div class="card__face card__face--front"><div class="card__content">${p2||'Player B'}’s cards</div></div>
            <div class="card__face card__face--back"><div class="card__content">Tap to browse ${p2||'Player B'}’s cards</div></div>
          </div>
        </article>

        <!-- 9 (bis1) -->
        <article class="card"><div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Spells ${p2||'P2'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select>${Array.from({length:9},(_,i)=>`<option>${i}</option>`).join('')}</select>
        <select id="spellsP2">...</select>
        </div></div>
        </div></article>

        <!-- 9 (bis2) -->
        <article class="card"><div class="card__inner">
        <div class="card__face card__face--front"><div class="card__content">Buildings ${p2||'P2'}?</div></div>
        <div class="card__face card__face--back"><div class="card__content">
        <select>${Array.from({length:9},(_,i)=>`<option>${i}</option>`).join('')}</select>
        <select id="buildingsP2">...</select>
        </div></div>
        </div></article>
      `;

      // guarded flip + open modal on 8/9
      const host = el.cardsHost;
      host.onclick = e => {
        if (e.target.closest('input,select,textarea,button,label')) return;
        const face = e.target.closest('.card__face'); if (!face) return;
        const card = face.closest('.card'); const inner = face.closest('.card__inner'); if (!inner) return;

        if (face.classList.contains('card__face--front')) {
          inner.classList.add('is-flipped'); inner.setAttribute('aria-pressed','true');
          if (card?.dataset?.player) openCardsModal(card.dataset.player);
        } else {
          inner.classList.remove('is-flipped'); inner.setAttribute('aria-pressed','false');
        }
      };
      host.onkeydown = e => {
        if (!['Enter',' '].includes(e.key)) return;
        const a = document.activeElement;
        if (a && ['INPUT','SELECT','TEXTAREA','BUTTON'].includes(a.tagName)) return;
        const card = e.target.closest('.card'); if (!card) return;
        const inner = card.querySelector('.card__inner'); if (!inner) return;
        e.preventDefault();
        const to = !inner.classList.contains('is-flipped');
        inner.classList.toggle('is-flipped', to);
        inner.setAttribute('aria-pressed', to);
        if (to && card.dataset.player) openCardsModal(card.dataset.player);
      };

      // winner single-select
      const winners = host.querySelectorAll('.winnerCheck');
      winners.forEach(cb=>cb.addEventListener('change',ev=>{
        if(!ev.target.checked) return; winners.forEach(o=>{ if(o!==ev.target) o.checked=false; });
      }));
    }

    // ---------- Cards Modal ----------
    function filteredAndSortedCards(q='', sort='') {
      const needle = norm(q);
      let arr = CARDS_DB.filter(c => !needle || norm(c.name_en).includes(needle) || norm(c.name_fr).includes(needle));
      if (sort === 'elixir') arr.sort((a,b)=>a.elixir-b.elixir || a.name_en.localeCompare(b.name_en));
      else if (sort === 'type') arr.sort((a,b)=>a.type.localeCompare(b.type) || a.name_en.localeCompare(b.name_en));
      else arr.sort((a,b)=>a.name_en.localeCompare(b.name_en));
      return arr;
    }

    function renderCardsGrid(q='') {
      const set = filteredAndSortedCards(q, ACTIVE_SORT);
      const selected = getSel(CURRENT_PLAYER_IN_MODAL);

      const imgSrc = (card) => {
        if (!card.img) return 'assets/cards/placeholder.webp';
        if (/^https?:\/\//i.test(card.img) || card.img.startsWith('assets/')) return card.img;
        return `assets/cards/${card.img}`;
      };

      el.cardsGrid.innerHTML = set.map(card => {
        const id = cardId(card); 
        const isSel = selected.has(id);
        return `
          <div class="cr-card ${isSel ? 'selected':''}" tabindex="0" data-id="${id}">
            <div class="cr-card__imgwrap">
              <img
                src="${imgSrc(card)}"
                alt="${card.name_en || card.name_fr || 'Card'}"
                loading="lazy"
                onerror="this.onerror=null; this.src='assets/cards/placeholder.webp'">
            </div>
            <div class="cr-card__meta">
              <div class="cr-card__name">
                ${card.name_en || ''} ${card.name_fr ? `<span class="muted">/ ${card.name_fr}</span>` : ''}
              </div>
              <div class="cr-card__tags">
                <span class="chip">${card.elixir ?? '—'}⚡</span>
                <span class="chip">${card.type || '—'}</span>
              </div>
            </div>
          </div>`;
      }).join('');

      if (!set.length) {
        el.cardsGrid.innerHTML = `<div class="muted" style="padding:16px;">No cards match your search.</div>`;
      }

      updateDeckCount();
    }

    function openCardsModal(player){
      CURRENT_PLAYER_IN_MODAL = player || '';
      // Keep title text + counter span
      const titleTextNode = el.modalTitle.firstChild; // "Player’s cards "
      titleTextNode.nodeValue = `${player}’s cards `;
      el.cardSearch.value = ''; ACTIVE_SORT = '';
      el.sortElixir.classList.remove('active'); el.sortType.classList.remove('active');
      renderCardsGrid('');
      el.modal.classList.remove('hidden'); el.modal.setAttribute('aria-hidden','false');
      setTimeout(()=>el.cardSearch.focus(), 50);
    }
    function closeCardsModal(){
      el.modal.classList.add('hidden'); el.modal.setAttribute('aria-hidden','true');
    }

    // Select / deselect in grid (max 8)
    el.cardsGrid.addEventListener('click', (e) => {
      const tile = e.target.closest('.cr-card');
      if (!tile) return;
      const id = tile.dataset.id?.trim();
      if (!id) return;

      const sel = getSel(CURRENT_PLAYER_IN_MODAL);

      if (sel.has(id)) {
        sel.delete(id);
        tile.classList.remove('selected');
      } else {
        if (sel.size >= MAX_DECK) {
          tile.classList.add('limit-warn');
          setTimeout(()=>tile.classList.remove('limit-warn'), 300);
          return;
        }
        sel.add(id);
        tile.classList.add('selected');
      }

      updateDeckCount();
    });

    el.modalBackdrop.addEventListener('click', closeCardsModal);
    el.modalClose.addEventListener('click', closeCardsModal);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && el.modal.getAttribute('aria-hidden')==='false') closeCardsModal(); });
    el.cardSearch.addEventListener('input', (e)=>renderCardsGrid(e.target.value));
    [el.sortElixir, el.sortType].forEach(btn=>{
      btn.addEventListener('click', ()=>{
        ACTIVE_SORT = btn.dataset.sort;
        el.sortElixir.classList.toggle('active', ACTIVE_SORT==='elixir');
        el.sortType.classList.toggle('active', ACTIVE_SORT==='type');
        renderCardsGrid(el.cardSearch.value);
      });
    });

    // ---------- Init ----------
    (async function init(){
      await loadCardsDB();
      await loadData();
      el.btn.addEventListener('click', loadData);
    })();
  </script>
</body>
</html>
