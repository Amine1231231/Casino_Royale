<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Manager</title>
  <link rel="stylesheet" href="../styles/style.css" />
  <style>
    /* Additional styles specific to this page */
    .page-section {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome-section {
      text-align: center;
      color: white;
      margin-bottom: 3rem;
      padding-top: 2rem;
    }

    .welcome-section h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .welcome-section p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .output {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: white;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .players-dropdown {
      position: relative;
    }

    .dropdown-container {
      position: relative;
      margin-bottom: 1rem;
    }

    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .dropdown-list.hidden {
      display: none;
    }

    .dropdown-item {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      color: #333;
      transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item.selected {
      background: rgba(102, 126, 234, 0.2);
      font-weight: bold;
    }

    .selected-players {
      min-height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 0.75rem;
    }

    .player-tag {
      display: inline-block;
      background: rgba(102, 126, 234, 0.8);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      margin: 0.25rem;
      font-size: 0.9rem;
      position: relative;
    }

    .player-tag .remove {
      margin-left: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      opacity: 0.8;
    }

    .player-tag .remove:hover {
      opacity: 1;
    }

    .loading-players {
      padding: 1rem;
      text-align: center;
      color: #666;
    }

    .nav-brand {
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      position: absolute;
      left: 2rem;
      top: 50%;
      transform: translateY(-50%);
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .welcome-section h1 {
        font-size: 2rem;
      }

      .nav-brand {
        position: static;
        transform: none;
        text-align: center;
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Floating Particles -->
  <div class="particles">
    <div class="particle" style="left: 10%; top: 20%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; top: 80%; animation-delay: 1s;"></div>
    <div class="particle" style="left: 30%; top: 40%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 40%; top: 70%; animation-delay: 3s;"></div>
    <div class="particle" style="left: 50%; top: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 60%; top: 60%; animation-delay: 5s;"></div>
    <div class="particle" style="left: 70%; top: 10%; animation-delay: 0.5s;"></div>
    <div class="particle" style="left: 80%; top: 50%; animation-delay: 1.5s;"></div>
    <div class="particle" style="left: 90%; top: 90%; animation-delay: 2.5s;"></div>
  </div>

  <header>
    <div class="container">
      <div class="nav-brand">League Manager</div>
      <nav>
        <ul>
          <li><a href="user.html">User</a></li>
          <li><a href="#" data-page="tournament" class="nav-link active">League</a></li>
          <li><a href="#" data-page="bet" class="nav-link">Bet</a></li>
          <li><a href="#" data-page="results" class="nav-link">Results</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="user-container">
    <!-- Tournament Section -->
    <section id="tournament" class="page-section active">
      <div class="welcome-section">
        <h1>League Management</h1>
        <p>Create and manage your tournaments</p>
      </div>
      
      <div class="grid">
        <div class="form-card">
          <h2>Create New Tournament</h2>
          <div class="form-group">
            <input type="text" id="leagueName" placeholder="League Name" />
          </div>
          <div class="form-group">
            <label style="color: white; margin-bottom: 0.5rem; display: block;">Select Players:</label>
            <div id="playersDropdown" class="players-dropdown">
              <div class="dropdown-container">
                <input type="text" id="playerSearch" placeholder="Search players..." />
                <div class="dropdown-list hidden" id="dropdownList">
                  <div class="loading-players">Loading players...</div>
                </div>
              </div>
              <div class="selected-players" id="selectedPlayers">
                <p style="color: rgba(255, 255, 255, 0.7); margin: 0;">No players selected</p>
              </div>
            </div>
          </div>
          <button id="createBtn" class="btn btn-primary" style="width: 100%;">Create League</button>
          <p id="message" class="message hidden"></p>
        </div>

        <div class="form-card">
          <h2>League Data</h2>
          <button id="loadBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">Load League Rounds</button>
          <div id="leagueOutput" class="output" style="min-height: 200px;">Click "Load League Rounds" to view tournament data...</div>
        </div>
      </div>
    </section>

    <!-- Bet Section -->
    <section id="bet" class="page-section">
      <div class="welcome-section">
        <h1>Betting</h1>
        <p>Place your bets on upcoming matches</p>
      </div>
      <div class="form-card">
        <h2>Coming Soon</h2>
        <p style="text-align: center; color: rgba(255, 255, 255, 0.8);">Betting functionality will be available soon.</p>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results" class="page-section">
      <div class="welcome-section">
        <h1>Results</h1>
        <p>View tournament results and statistics</p>
      </div>
      <div class="form-card">
        <h2>Coming Soon</h2>
        <p style="text-align: center; color: rgba(255, 255, 255, 0.8);">Results functionality will be available soon.</p>
      </div>
    </section>
  </main>

  <script>
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbyqKp7RgGbE-NhVqTILvSs-GTVYoulN5u7FKQ-FfaXxbr0DAsrzNPj0zrvQD92iTQFqzQ/exec";

    let allPlayers = [];
    let selectedPlayers = [];
    let currentUser = null;

    // Load current user from localStorage
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('casinoUser');
      if (saved) {
        currentUser = JSON.parse(saved);
      }
      loadPlayers();
    });

    // Navigation functionality
    function showPage(pageId) {
      // Hide all sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(pageId).classList.add('active');
      
      // Update navigation active state
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
    }

    // Add click listeners to navigation links
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageId = link.getAttribute('data-page');
        showPage(pageId);
      });
    });

    // API call function
    async function callAPI(action, data = {}) {
      const formData = new FormData();
      formData.append("action", action);
      for (const key in data) {
        formData.append(key, data[key]);
      }
      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: formData,
        });
        return res.json();
      } catch (err) {
        return { success: false, message: "Connection error" };
      }
    }

    // Load players from the backend
    async function loadPlayers() {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getPlayers`);
        const result = await response.json();
        
        if (result.success && result.players) {
          allPlayers = result.players;
          updateDropdownList();
        } else {
          document.getElementById('dropdownList').innerHTML = 
            '<div class="loading-players">No players found</div>';
        }
      } catch (error) {
        document.getElementById('dropdownList').innerHTML = 
          '<div class="loading-players">Error loading players</div>';
      }
    }

    // Update dropdown list based on search
    function updateDropdownList(searchTerm = '') {
      const dropdownList = document.getElementById('dropdownList');
      const filteredPlayers = allPlayers.filter(player => 
        player.username.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !selectedPlayers.find(selected => selected.username === player.username)
      );

      if (filteredPlayers.length === 0) {
        dropdownList.innerHTML = '<div class="loading-players">No players available</div>';
      } else {
        dropdownList.innerHTML = filteredPlayers.map(player => `
          <div class="dropdown-item" data-username="${player.username}" data-clash-id="${player.clashId}">
            <strong>${player.username}</strong> - ${player.clashId}
          </div>
        `).join('');
      }
    }

    // Player search functionality
    document.getElementById('playerSearch').addEventListener('input', (e) => {
      const searchTerm = e.target.value;
      updateDropdownList(searchTerm);
      document.getElementById('dropdownList').classList.remove('hidden');
    });

    // Show dropdown when search field is focused
    document.getElementById('playerSearch').addEventListener('focus', () => {
      updateDropdownList(document.getElementById('playerSearch').value);
      document.getElementById('dropdownList').classList.remove('hidden');
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown-container')) {
        document.getElementById('dropdownList').classList.add('hidden');
      }
    });

    // Handle player selection from dropdown
    document.getElementById('dropdownList').addEventListener('click', (e) => {
      const item = e.target.closest('.dropdown-item');
      if (!item) return;

      const username = item.dataset.username;
      const clashId = item.dataset.clashId;
      
      // Add to selected players
      selectedPlayers.push({ username, clashId });
      
      // Update UI
      updateSelectedPlayersDisplay();
      updateDropdownList(document.getElementById('playerSearch').value);
      document.getElementById('playerSearch').value = '';
    });

    // Update selected players display
    function updateSelectedPlayersDisplay() {
      const container = document.getElementById('selectedPlayers');
      
      if (selectedPlayers.length === 0) {
        container.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7); margin: 0;">No players selected</p>';
      } else {
        container.innerHTML = selectedPlayers.map((player, index) => `
          <span class="player-tag">
            ${player.username}
            <span class="remove" data-index="${index}">Ã—</span>
          </span>
        `).join('');
      }
    }

    // Handle player removal
    document.getElementById('selectedPlayers').addEventListener('click', (e) => {
      if (e.target.classList.contains('remove')) {
        const index = parseInt(e.target.dataset.index);
        selectedPlayers.splice(index, 1);
        updateSelectedPlayersDisplay();
        updateDropdownList(document.getElementById('playerSearch').value);
      }
    });

    // Create league functionality
    document.getElementById("createBtn").addEventListener("click", async () => {
      const leagueName = document.getElementById("leagueName").value.trim();
      const messageEl = document.getElementById("message");
      
      messageEl.classList.remove("error", "success", "hidden");
      
      if (!leagueName || selectedPlayers.length < 2) {
        messageEl.textContent = "Please enter a league name and select at least 2 players.";
        messageEl.classList.add("error");
        return;
      }

      if (!currentUser) {
        messageEl.textContent = "Please log in to create a tournament.";
        messageEl.classList.add("error");
        return;
      }
      
      // Show loading state
      const createBtn = document.getElementById("createBtn");
      const originalText = createBtn.textContent;
      createBtn.textContent = "Creating...";
      createBtn.disabled = true;
      
      // Prepare tournament data
      const tournamentData = {
        tournamentName: leagueName,
        createdBy: currentUser.username,
        players: selectedPlayers.map(p => p.username),
        timestamp: new Date().toISOString()
      };
      
      const result = await callAPI("Tournament_create", {
        tournamentName: leagueName,
        createdBy: currentUser.username,
        players: JSON.stringify(selectedPlayers.map(p => p.username))
      });
      
      messageEl.textContent = result.message || "Tournament created successfully!";
      messageEl.classList.add(result.success ? "success" : "error");
      
      // Reset button
      createBtn.textContent = originalText;
      createBtn.disabled = false;
      
      // Clear form on success
      if (result.success) {
        document.getElementById("leagueName").value = "";
        selectedPlayers = [];
        updateSelectedPlayersDisplay();
        updateDropdownList();
      }
    });

    // Load league data functionality
    document.getElementById("loadBtn").addEventListener("click", async () => {
      const outputEl = document.getElementById("leagueOutput");
      const loadBtn = document.getElementById("loadBtn");
      
      // Show loading state
      const originalText = loadBtn.textContent;
      loadBtn.textContent = "Loading...";
      loadBtn.disabled = true;
      outputEl.textContent = "Loading league data...";
      
      const result = await callAPI("Tournament_getRounds");
      
      if (result.success) {
        if (result.data && result.data.data && result.data.data.length > 0) {
          // Format the tournament data nicely
          const formattedData = result.data.data
            .filter(row => row[0]) // Remove empty rows
            .map(row => row[0])    // Get first column
            .join('\n');
          outputEl.textContent = formattedData;
        } else {
          outputEl.textContent = "No tournament data found. Create a tournament first.";
        }
      } else {
        outputEl.textContent = `Error: ${result.message}`;
      }
      
      // Reset button
      loadBtn.textContent = originalText;
      loadBtn.disabled = false;
    });
  </script>
</body>
</html>
