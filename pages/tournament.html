<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Casino Royale - League (Debug Version)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../styles/style.css" />
  <style>
    /* small local tweaks to ensure empty landing and nice spacing */
    .center-area { min-height: 60vh; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:1rem; }
    .hidden { display:none !important; }
    .player-list { max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:6px; background:rgba(0,0,0,0.03); }
    .player-item { display:flex; align-items:center; gap:8px; padding:6px 4px; border-radius:4px; }
    .player-tag { display:inline-block; padding:4px 8px; margin:3px; border-radius:12px; background:rgba(0,0,0,0.06); }
    .league-output { white-space:pre-wrap; font-family:monospace; }
    .controls-row { display:flex; gap:8px; align-items:center; }
    .debug-info { background: rgba(255,0,0,0.1); padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
    .loading-players { color: #ffcc00; padding: 10px; text-align: center; }
  </style>
</head>
<body>
  <!-- Debug Info Panel -->
  <div id="debugInfo" class="debug-info">
    <strong>Debug Info:</strong><br>
    <span id="debugText">Loading debug information...</span>
  </div>

  <!-- Floating Particles -->
  <div class="particles"></div>

  <!-- Header Navigation (same as user.html) -->
  <header>
    <div class="container">
      <nav>
        <ul>
          <li><a href="user.html">User</a></li>
          <li><a href="tournament.html" class="active">League</a></li>
          <li><a href="bet.html">Bet</a></li>
          <li><a href="results.html">Results</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="user-container">
    <!-- Center area: starts "empty" except Create League button -->
    <div class="center-area" id="centerArea">
      <button id="openCreateBtn" class="btn btn-primary btn-large">Create League</button>
      <div id="noDataNotice" class="muted">No league currently available.</div>
    </div>

    <!-- Create Form (hidden until user clicks Create League) -->
    <div id="createFormCard" class="form-card hidden" style="max-width:820px;margin:18px auto;">
      <h2>Create New Tournament</h2>

      <div class="form-group">
        <input type="text" id="leagueName" placeholder="League Name" />
      </div>

      <div class="form-group">
        <label for="playerSearch">Select Players (min 2):</label>
        <div style="display:flex; gap:12px;">
          <div style="flex:1;">
            <input id="playerSearch" placeholder="Search players..." />
            <div id="playerList" class="player-list">
              <div class="loading-players">Loading players...</div>
            </div>
          </div>
          <div style="width:260px;">
            <div style="font-weight:600;margin-bottom:6px;">Selected</div>
            <div id="selectedPlayers" style="min-height:48px; border:1px dashed rgba(255,255,255,0.04); padding:8px; border-radius:6px;">
              <p class="muted">No players selected</p>
            </div>
          </div>
        </div>
      </div>

      <div class="controls-row" style="margin-top:12px;">
        <button id="createBtn" class="btn btn-primary">Create League</button>
        <button id="cancelCreateBtn" class="btn btn-secondary">Cancel</button>
        <div id="createMessage" class="message hidden" style="margin-left:12px;"></div>
      </div>
    </div>

    <!-- League Data (hidden until there is existing league or after create) -->
    <div id="leagueDataCard" class="form-card hidden" style="max-width:900px;margin:18px auto;">
      <h2>League Data</h2>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <button id="reloadLeagueBtn" class="btn btn-secondary">Reload League Rounds</button>
        <button id="clearLeagueBtn" class="btn btn-danger">Clear League (wipe)</button>
        <div id="leagueStatus" class="muted" style="margin-left:8px;"></div>
      </div>
      <div id="leagueOutput" class="league-output">Loading...</div>
    </div>
  </div>

  <script>
    // Debug function
    function debugLog(message) {
      console.log('DEBUG:', message);
      const debugText = document.getElementById('debugText');
      debugText.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
    }

    // use the same script url as user.html
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbyqKp7RgGbE-NhVqTILvSs-GTVYoulN5u7FKQ-FfaXxbr0DAsrzNPj0zrvQD92iTQFqzQ/exec";

    debugLog('SCRIPT_URL initialized: ' + SCRIPT_URL);

    // state
    let allPlayers = [];
    let selectedPlayers = [];
    let currentUser = null;

    // helper: show temporary messages
    function showMessage(elId, text, type='info', duration=4500){
      debugLog('showMessage called: ' + elId + ' - ' + text + ' - ' + type);
      const el = document.getElementById(elId);
      if (!el) {
        debugLog('ERROR: Element not found: ' + elId);
        return;
      }
      el.textContent = text;
      el.className = 'message ' + (type==='error' ? 'error' : type==='success' ? 'success' : '');
      el.classList.remove('hidden');
      if(duration) setTimeout(()=>el.classList.add('hidden'), duration);
    }
    function hideEl(id){ 
      debugLog('hideEl called: ' + id);
      document.getElementById(id)?.classList.add('hidden'); 
    }
    function showEl(id){ 
      debugLog('showEl called: ' + id);
      document.getElementById(id)?.classList.remove('hidden'); 
    }

    // particles (same generation as user.html)
    const particleContainer = document.querySelector('.particles');
    for(let i=0;i<6;i++){
      const p = document.createElement('div');
      p.className = 'particle';
      particleContainer.appendChild(p);
    }
    debugLog('Particles created');

    // API utility
    async function callAPI(action, data = {}) {
      debugLog('callAPI called: ' + action + ' with data: ' + JSON.stringify(data));
      // For read endpoints sometimes GET with ?action is used in your other pages; here we'll use POST for actions
      const formData = new FormData();
      formData.append('action', action);
      Object.keys(data).forEach(k=>formData.append(k, data[k]));
      try{
        debugLog('Making fetch request to: ' + SCRIPT_URL);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        debugLog('Response status: ' + res.status + ' ' + res.statusText);
        const result = await res.json();
        debugLog('API Response: ' + JSON.stringify(result));
        return result;
      } catch (e) {
        debugLog('API Error: ' + e.message);
        return { success: false, message: 'Connection error: ' + e.message };
      }
    }

    // load players (same source as user.html)
    async function loadPlayers() {
      debugLog('loadPlayers started');
      const playerListEl = document.getElementById('playerList');
      if (!playerListEl) {
        debugLog('ERROR: playerList element not found!');
        return;
      }
      
      playerListEl.innerHTML = '<div class="loading-players">Loading players...</div>';
      debugLog('Set loading message in playerList');
      
      try {
        const url = `${SCRIPT_URL}?action=getPlayers`;
        debugLog('Fetching players from: ' + url);
        
        const res = await fetch(url);
        debugLog('Players fetch response status: ' + res.status);
        
        if (!res.ok) {
          throw new Error('HTTP ' + res.status + ': ' + res.statusText);
        }
        
        const data = await res.json();
        debugLog('Players data received: ' + JSON.stringify(data));
        
        allPlayers = data.success && Array.isArray(data.players) ? data.players : [];
        debugLog('allPlayers set to: ' + JSON.stringify(allPlayers));
        
        if (!data.success) {
          debugLog('API returned success=false: ' + (data.message || 'Unknown error'));
          playerListEl.innerHTML = '<div class="loading-players">API Error: ' + (data.message || 'Unknown error') + '</div>';
          return;
        }
        
        if (allPlayers.length === 0) {
          debugLog('No players found in response');
          playerListEl.innerHTML = '<div class="loading-players">No players found</div>';
          return;
        }
        
        renderPlayerCheckboxes();
        debugLog('renderPlayerCheckboxes called successfully');
        
      } catch (e) {
        debugLog('Exception in loadPlayers: ' + e.message);
        debugLog('Stack trace: ' + e.stack);
        playerListEl.innerHTML = '<div class="loading-players">Error loading players: ' + e.message + '</div>';
      }
    }

    function renderPlayerCheckboxes(filter='') {
      debugLog('renderPlayerCheckboxes called with filter: "' + filter + '"');
      const playerListEl = document.getElementById('playerList');
      if (!playerListEl) {
        debugLog('ERROR: playerList element not found in renderPlayerCheckboxes!');
        return;
      }
      
      const term = filter.trim().toLowerCase();
      const filtered = allPlayers.filter(p => {
        const notSelected = !selectedPlayers.find(s => s.username === p.username);
        const matches = p.username.toLowerCase().includes(term) || (p.clashId || '').toLowerCase().includes(term);
        return notSelected && matches;
      });
      
      debugLog('Filtered players: ' + filtered.length + ' out of ' + allPlayers.length);

      if(filtered.length === 0) {
        playerListEl.innerHTML = '<div class="loading-players">No players available</div>';
        debugLog('No players available message set');
        return;
      }

      const html = filtered.map(p => `
        <label class="player-item">
          <input type="checkbox" class="player-checkbox" data-username="${p.username}" data-clash-id="${p.clashId}" />
          <span style="font-weight:600;">${p.username}</span> <small style="opacity:.7;margin-left:6px;">- ${p.clashId || ''}</small>
        </label>
      `).join('');
      
      playerListEl.innerHTML = html;
      debugLog('Player checkboxes rendered: ' + filtered.length + ' players');
    }

    function refreshSelectedDisplay() {
      debugLog('refreshSelectedDisplay called');
      const el = document.getElementById('selectedPlayers');
      if (!el) {
        debugLog('ERROR: selectedPlayers element not found!');
        return;
      }
      
      if(selectedPlayers.length === 0) {
        el.innerHTML = '<p class="muted">No players selected</p>';
        return;
      }
      el.innerHTML = selectedPlayers.map((p,i)=>`
        <div class="player-tag" data-index="${i}">
          ${p.username} <span class="remove" data-index="${i}" style="cursor:pointer;margin-left:8px;">×</span>
        </div>
      `).join('');
      debugLog('Selected players display updated: ' + selectedPlayers.length + ' players');
    }

    // page behavior
    window.addEventListener('load', async () => {
      debugLog('Window loaded event fired');
      
      const saved = localStorage.getItem('casinoUser');
      if(saved) {
        try { 
          currentUser = JSON.parse(saved); 
          debugLog('Current user loaded: ' + currentUser.username);
        } catch(e){ 
          debugLog('Error parsing saved user: ' + e.message);
          localStorage.removeItem('casinoUser'); 
        }
      } else {
        debugLog('No saved user found');
      }
      
      // Check if a league exists already — if so, show it in League Data
      debugLog('Checking for existing league...');
      await checkAndLoadExistingLeague();
      
      // Prepare players in background in case user opens create form
      debugLog('Loading players...');
      await loadPlayers();
      debugLog('Initial load complete');
    });

    // Check existing league and show leagueDataCard if something is present
    async function checkAndLoadExistingLeague(){
      debugLog('checkAndLoadExistingLeague started');
      const res = await callAPI('Tournament_getRounds');
      if(res.success && res.data?.data?.length > 0) {
        // show league data card and populate
        showEl('leagueDataCard');
        hideEl('noDataNotice');
        renderLeagueData(res.data.data);
        debugLog('Existing league found and displayed');
      } else {
        // No league exists: keep page visually minimal (only create button and noDataNotice)
        hideEl('leagueDataCard');
        showEl('noDataNotice');
        debugLog('No existing league found');
      }
    }

    function renderLeagueData(sheetDataRows){
      debugLog('renderLeagueData called with ' + sheetDataRows.length + ' rows');
      // The backend returns sheet-like rows; we'll present them clearly.
      // If each row contains a textual representation in index 0 (like earlier code), join them.
      const lines = sheetDataRows
        .map(r => Array.isArray(r) ? r.join(' | ').trim() : (r||''))
        .filter(l => l && l !== '')
        .join('\n');
      document.getElementById('leagueOutput').textContent = lines || 'No readable league rows found.';
      document.getElementById('leagueStatus').textContent = `Rounds: ${sheetDataRows.length}`;
    }

    // Open create form
    document.getElementById('openCreateBtn').addEventListener('click', () => {
      debugLog('Open create button clicked');
      showEl('createFormCard');
      // scroll into view for convenience
      document.getElementById('createFormCard').scrollIntoView({behavior:'smooth', block:'center'});
    });

    // Cancel create
    document.getElementById('cancelCreateBtn').addEventListener('click', () => {
      debugLog('Cancel create button clicked');
      hideEl('createFormCard');
      // reset selection
      selectedPlayers = [];
      refreshSelectedDisplay();
      renderPlayerCheckboxes();
    });

    // Search players input
    document.getElementById('playerSearch').addEventListener('input', (e) => {
      debugLog('Player search input: "' + e.target.value + '"');
      renderPlayerCheckboxes(e.target.value);
    });

    // Delegate clicks in playerList to handle checkbox selection
    document.getElementById('playerList').addEventListener('change', (e) => {
      const cb = e.target.closest('.player-checkbox');
      if(!cb) return;
      debugLog('Player checkbox changed: ' + cb.dataset.username + ' checked=' + cb.checked);
      const username = cb.dataset.username;
      const clashId = cb.dataset.clashId;
      if(cb.checked) {
        selectedPlayers.push({ username, clashId });
      } else {
        selectedPlayers = selectedPlayers.filter(p => p.username !== username);
      }
      refreshSelectedDisplay();
      // re-render available list so selected ones disappear
      renderPlayerCheckboxes(document.getElementById('playerSearch').value);
    });

    // Remove from selected when clicking ×
    document.getElementById('selectedPlayers').addEventListener('click', (e) => {
      const rem = e.target.closest('.remove');
      if(!rem) return;
      debugLog('Remove player clicked: index ' + rem.dataset.index);
      const idx = parseInt(rem.dataset.index);
      if(isNaN(idx)) return;
      const removed = selectedPlayers.splice(idx,1);
      refreshSelectedDisplay();
      renderPlayerCheckboxes(document.getElementById('playerSearch').value);
    });

    // Create League action
    document.getElementById('createBtn').addEventListener('click', async () => {
      debugLog('Create league button clicked');
      const leagueName = document.getElementById('leagueName').value.trim();
      const msgElId = 'createMessage';

      if(!leagueName || selectedPlayers.length < 2) {
        showMessage(msgElId, 'Enter a league name and select at least 2 players.', 'error');
        return;
      }
      if(!currentUser) {
        showMessage(msgElId, 'You must be logged in to create a league. Please log in at the User page.', 'error');
        return;
      }

      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';

      // Call backend
      const payload = {
        tournamentName: leagueName,
        createdBy: currentUser.username,
        players: JSON.stringify(selectedPlayers.map(p => p.username))
      };
      const res = await callAPI('Tournament_create', payload);

      if(res.success) {
        showMessage(msgElId, res.message || 'Tournament created successfully!', 'success');
        // Clear form and selected players
        document.getElementById('leagueName').value = '';
        selectedPlayers = [];
        refreshSelectedDisplay();
        renderPlayerCheckboxes();
        hideEl('createFormCard');
        // After creating, reload league display
        await checkAndLoadExistingLeague();
        // scroll to league data
        showEl('leagueDataCard');
        document.getElementById('leagueDataCard').scrollIntoView({behavior:'smooth', block:'center'});
      } else {
        showMessage(msgElId, res.message || 'Error creating tournament', 'error');
      }

      createBtn.disabled = false;
      createBtn.textContent = 'Create League';
    });

    // Reload league button
    document.getElementById('reloadLeagueBtn').addEventListener('click', async () => {
      debugLog('Reload league button clicked');
      const btn = document.getElementById('reloadLeagueBtn');
      btn.disabled = true;
      btn.textContent = 'Loading...';
      const res = await callAPI('Tournament_getRounds');
      if(res.success && res.data?.data?.length > 0) {
        renderLeagueData(res.data.data);
        showEl('leagueDataCard');
        hideEl('noDataNotice');
      } else {
        document.getElementById('leagueOutput').textContent = res.success ? 'No tournament data found.' : 'Error: ' + res.message;
        if(!res.success) showMessage('createMessage', res.message || 'Error loading league', 'error');
      }
      btn.disabled = false;
      btn.textContent = 'Reload League Rounds';
    });

    // Clear league (wipe) - optional: calls backend action you said existed earlier (if implemented)
    document.getElementById('clearLeagueBtn').addEventListener('click', async () => {
      if(!confirm('This will wipe the existing League sheet data. Continue?')) return;
      debugLog('Clear league confirmed');
      const res = await callAPI('Tournament_clear'); // implement server-side action as needed
      if(res.success) {
        showMessage('createMessage', res.message || 'League cleared.', 'success');
        hideEl('leagueDataCard');
        showEl('noDataNotice');
        document.getElementById('leagueOutput').textContent = '';
      } else {
        showMessage('createMessage', res.message || 'Failed to clear league.', 'error');
      }
    });

  </script>
</body>
</html>
