<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Casino Royale - User</title>
  <link rel="stylesheet" href="../styles/style.css">
  <style>
    .user-container {
      padding-top: 120px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
    }
    
    .auth-forms {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .form-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 2rem;
      width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .form-card h2 {
      color: white;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .btn {
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #4facfe, #00f2fe);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .players-section {
      width: 100%;
      max-width: 800px;
      display: none;
    }
    
    .players-section.active {
      display: block;
    }
    
    .players-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .players-header h2 {
      color: white;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .welcome-msg {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 1rem;
    }
    
    .players-list {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 1.5rem;
      color: white;
    }
    
    .player-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-item:last-child {
      border-bottom: none;
    }
    
    .message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .error {
      background: rgba(255, 87, 108, 0.2);
      border: 1px solid rgba(255, 87, 108, 0.5);
      color: #ff576c;
    }
    
    .success {
      background: rgba(79, 172, 254, 0.2);
      border: 1px solid rgba(79, 172, 254, 0.5);
      color: #4facfe;
    }

    .debug-section {
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-width: 600px;
    }

    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- Floating particles -->
  <div class="particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>
  
  <header>
    <div class="container">
      <nav>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="user.html" class="active">User</a></li>
          <li><a href="tournament.html">Tournament</a></li>
          <li><a href="bet.html">Bet</a></li>
          <li><a href="results.html">Results</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="user-container">
    <!-- Debug Section -->
    <div class="debug-section" id="debugSection" style="display: none;">
      <h3>Debug Info:</h3>
      <div id="debugContent"></div>
      <button onclick="testAPI()" class="btn btn-secondary" style="margin-top: 10px;">Test API</button>
      <button onclick="toggleDebug()" class="btn btn-secondary" style="margin-top: 10px;">Hide Debug</button>
    </div>
    
    <button onclick="toggleDebug()" class="btn btn-secondary" style="margin-bottom: 20px;">Show Debug</button>

    <!-- Auth Forms -->
    <div class="auth-forms" id="authForms">
      <!-- Register -->
      <div class="form-card">
        <h2>Create Account</h2>
        <div id="registerMessage" class="message" style="display: none;"></div>
        <form id="registerForm">
          <div class="form-group">
            <input type="text" id="regUsername" placeholder="Username" required>
          </div>
          <div class="form-group">
            <input type="text" id="regClashId" placeholder="Clash ID" required>
          </div>
          <div class="form-group">
            <input type="password" id="regPassword" placeholder="Password" required>
          </div>
          <button type="submit" class="btn btn-primary">Create Account</button>
        </form>
      </div>
      
      <!-- Login -->
      <div class="form-card">
        <h2>Log In</h2>
        <div id="loginMessage" class="message" style="display: none;"></div>
        <form id="loginForm">
          <div class="form-group">
            <input type="text" id="loginUsername" placeholder="Username" required>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" placeholder="Password" required>
          </div>
          <button type="submit" class="btn btn-primary">Log In</button>
        </form>
      </div>
    </div>

    <!-- Players Section -->
    <div class="players-section" id="playersSection">
      <div class="players-header">
        <h2>Online Players</h2>
        <p class="welcome-msg">Welcome, <span id="currentUser"></span>!</p>
        <button class="btn btn-secondary" onclick="loadPlayers()">Refresh Players</button>
        <button class="btn btn-secondary" onclick="logout()" style="margin-left: 1rem;">Logout</button>
      </div>
      <div class="players-list" id="playersList">
        Loading players...
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdLed222yV3Hu7JEMhTEdfm7GdQSqoZk68obU86QTHL37EKuKlYhNpT_3l8Su6KpugCw/exec";
let currentUserData = null;

// Check if user is logged in
window.addEventListener('load', () => {
  const saved = localStorage.getItem('casinoUser');
  if (saved) {
    currentUserData = JSON.parse(saved);
    showPlayersSection();
  }
});

// API helper function
async function callAPI(action, data = {}) {
  const formData = new FormData();
  formData.append('action', action);
  
  Object.keys(data).forEach(key => formData.append(key, data[key]));
  
  const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
  return await response.json();
}

// Register form
document.getElementById('registerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('regUsername').value.trim();
  const clashId = document.getElementById('regClashId').value.trim();
  const password = document.getElementById('regPassword').value;
  
  try {
    const result = await callAPI('register', { username, clashId, password });
    if (result.success) {
      showMessage('registerMessage', result.message, 'success');
      document.getElementById('registerForm').reset();
    } else {
      showMessage('registerMessage', result.message, 'error');
    }
  } catch {
    showMessage('registerMessage', 'Connection error. Please try again.', 'error');
  }
});

// Login form
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  try {
    const result = await callAPI('login', { username, password });
    if (result.success) {
      currentUserData = { username: result.username, clashId: result.clashId };
      localStorage.setItem('casinoUser', JSON.stringify(currentUserData));
      showPlayersSection();
    } else {
      showMessage('loginMessage', result.message, 'error');
    }
  } catch {
    showMessage('loginMessage', 'Connection error. Please try again.', 'error');
  }
});

// Show players section
function showPlayersSection() {
  document.getElementById('authForms').style.display = 'none';
  document.getElementById('playersSection').classList.add('active');
  document.getElementById('currentUser').textContent = currentUserData.username;
  loadPlayers();
}

// Load players
async function loadPlayers() {
  try {
    const result = await fetch(`${SCRIPT_URL}?action=getPlayers`).then(r => r.json());
    if (result.success && result.players) {
      displayPlayers(result.players);
    } else {
      document.getElementById('playersList').innerHTML = 'No players found.';
    }
  } catch {
    document.getElementById('playersList').innerHTML = 'Error loading players.';
  }
}

// Display players
function displayPlayers(players) {
  const html = players.map(player => `
    <div class="player-item">
      <strong>${player.username}</strong> - ${player.clashId} 
      <span style="color: ${player.online ? '#4facfe' : '#999'};">
        (${player.online ? 'Online' : 'Offline'})
      </span>
    </div>
  `).join('');
  
  document.getElementById('playersList').innerHTML = html || 'No players found.';
}

// Logout
async function logout() {
  if (currentUserData) {
    try { await callAPI('logout', { username: currentUserData.username }); } catch {}
  }
  currentUserData = null;
  localStorage.removeItem('casinoUser');
  document.getElementById('playersSection').classList.remove('active');
  document.getElementById('authForms').style.display = 'flex';
  document.getElementById('loginForm').reset();
  hideMessages();
}

// Show message
function showMessage(elementId, message, type) {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.className = `message ${type}`;
  element.style.display = 'block';
  
  setTimeout(() => { element.style.display = 'none'; }, 5000);
}

// Hide messages
function hideMessages() {
  document.querySelectorAll('.message').forEach(el => { el.style.display = 'none'; });
}
    // Particle effects
    document.addEventListener('mousemove', (e) => {
      const cursor = { x: e.clientX, y: e.clientY };
      const particles = document.querySelectorAll('.particle');
      
      particles.forEach((particle, index) => {
        const speed = (index + 1) * 0.02;
        const x = (cursor.x * speed) % window.innerWidth;
        const y = (cursor.y * speed) % window.innerHeight;
        
        particle.style.transform = `translate(${x * 0.1}px, ${y * 0.1}px)`;
      });
    });
    
    // Ripple effect
    document.addEventListener('click', (e) => {
      const ripple = document.createElement('div');
      ripple.style.cssText = `
        position: fixed;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple 0.6s linear;
        left: ${e.clientX - 25}px;
        top: ${e.clientY - 25}px;
        width: 50px;
        height: 50px;
        pointer-events: none;
        z-index: 9999;
      `;
      
      document.body.appendChild(ripple);
      setTimeout(() => document.body.removeChild(ripple), 600);
    });
    
    // Add ripple animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
