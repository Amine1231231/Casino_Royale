<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Casino Royale - User</title>
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body>
  <!-- Floating Particles -->
  <div class="particles"></div>

  <!-- Header Navigation -->
  <header>
    <div class="container">
      <nav>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="user.html" class="active">User</a></li>
          <li><a href="tournament.html">League</a></li>
          <li><a href="bet.html">Bet</a></li>
          <li><a href="results.html">Results</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="user-container">

    <!-- Auth Forms -->
    <div class="auth-forms" id="authForms">
      <div class="form-card">
        <h2>Create Account</h2>
        <div id="registerMessage" class="message hidden"></div>
        <form id="registerForm">
          <div class="form-group">
            <input type="text" id="regUsername" placeholder="Username" required>
          </div>
          <div class="form-group">
            <input type="text" id="regClashId" placeholder="Clash ID" required>
          </div>
          <div class="form-group">
            <input type="password" id="regPassword" placeholder="Password" required>
          </div>
          <button type="submit" class="btn btn-primary">Create Account</button>
        </form>
      </div>
      <div class="form-card">
        <h2>Log In</h2>
        <div id="loginMessage" class="message hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <input type="text" id="loginUsername" placeholder="Username" required>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" placeholder="Password" required>
          </div>
          <button type="submit" class="btn btn-primary">Log In</button>
        </form>
      </div>
    </div>

    <!-- Players Section -->
    <div class="players-section hidden" id="playersSection">
      <div class="players-header">
        <div>
          <h2>Online Players</h2>
          <p class="welcome-msg">Welcome, <span id="currentUser"></span>!</p>
        </div>
        <div>
          <button class="btn btn-secondary" id="refreshBtn">Refresh</button>
          <button class="btn btn-secondary" id="logoutBtn">Logout</button>
        </div>
      </div>
      <div class="players-list" id="playersList">Loading players...</div>
    </div>

    <!-- Player Detail -->
    <div class="player-detail hidden" id="playerDetail">
      <h3 id="detailUsername"></h3>
      <p><strong>Clash ID:</strong> <span id="detailClashId"></span></p>
      <p><strong>Funds:</strong> <span id="detailFunds"></span></p>
      <p><strong>Upcoming Match:</strong> <span id="detailMatch"></span></p>
      <button class="btn btn-secondary" id="backBtn">Back</button>
    </div>

  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2AfQ7auVoNbEiqdYnsQXh0elk29qUv3phbct45tbFtUunbZC6OZ9crEGnpbjwXH9Q5A/exec";
    let currentUserData = null;

    // Generate particles dynamically
    const particleContainer = document.querySelector('.particles');
    for(let i=0;i<6;i++){
      const p = document.createElement('div');
      p.className = 'particle';
      particleContainer.appendChild(p);
    }

    // Utility functions
    const showMessage = (id, msg, type) => {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = `message ${type}`;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 5000);
    };
    const hideMessages = () => document.querySelectorAll('.message').forEach(el=>el.classList.add('hidden'));

    const callAPI = async (action, data={}) => {
      const formData = new FormData();
      formData.append('action', action);
      Object.keys(data).forEach(k=>formData.append(k, data[k]));
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      return await res.json();
    };

    // Load saved user
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('casinoUser');
      if(saved){
        currentUserData = JSON.parse(saved);
        showPlayersSection();
      }
    });

    // Register
    document.getElementById('registerForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const username = document.getElementById('regUsername').value.trim();
      const clashId = document.getElementById('regClashId').value.trim();
      const password = document.getElementById('regPassword').value;
      try {
        const result = await callAPI('register',{username, clashId, password});
        showMessage('registerMessage', result.message, result.success?'success':'error');
        if(result.success) e.target.reset();
      } catch { showMessage('registerMessage','Connection error','error'); }
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const result = await callAPI('login',{username,password});
        if(result.success){
          currentUserData = { username: result.username, clashId: result.clashId };
          localStorage.setItem('casinoUser', JSON.stringify(currentUserData));
          showPlayersSection();
        } else showMessage('loginMessage', result.message,'error');
      } catch { showMessage('loginMessage','Connection error','error'); }
    });

    // Show players section
    function showPlayersSection(){
      document.getElementById('authForms').classList.add('hidden');
      document.getElementById('playersSection').classList.remove('hidden');
      document.getElementById('currentUser').textContent = currentUserData.username;
      loadPlayers();
    }

    // Load players
    async function loadPlayers(){
      const list = document.getElementById('playersList');
      try{
        const result = await fetch(`${SCRIPT_URL}?action=getPlayers`).then(r=>r.json());
        if(result.success && result.players){
          list.innerHTML = result.players.map(p=>`
            <div class="player-item" data-username="${p.username}" data-clash-id="${p.clashId}">
              <strong>${p.username}</strong> - ${p.clashId} 
              <span class="${p.online?'online':'offline'}">(${p.online?'Online':'Offline'})</span>
            </div>
          `).join('');
        } else list.textContent = 'No players found.';
      } catch { list.textContent='Error loading players.'; }
    }

    // Event delegation for player click
    document.getElementById('playersList').addEventListener('click', e=>{
      const item = e.target.closest('.player-item');
      if(!item) return;
      document.getElementById('playersSection').classList.add('hidden');
      const detail = document.getElementById('playerDetail');
      detail.classList.remove('hidden');
      document.getElementById('detailUsername').textContent = item.dataset.username;
      document.getElementById('detailClashId').textContent = item.dataset.clashId;
      document.getElementById('detailFunds').textContent = ''; // Placeholder
      document.getElementById('detailMatch').textContent = ''; // Placeholder
    });

    // Back button
    document.getElementById('backBtn').addEventListener('click', ()=>{
      document.getElementById('playerDetail').classList.add('hidden');
      document.getElementById('playersSection').classList.remove('hidden');
    });

    // Refresh
    document.getElementById('refreshBtn').addEventListener('click', loadPlayers);

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      if(currentUserData){
        try { await callAPI('logout',{username:currentUserData.username}); } catch {}
      }
      currentUserData=null;
      localStorage.removeItem('casinoUser');
      document.getElementById('authForms').classList.remove('hidden');
      document.getElementById('playersSection').classList.add('hidden');
      document.getElementById('playerDetail').classList.add('hidden');
      document.getElementById('loginForm').reset();
      hideMessages();
    });
  </script>
</body>
</html>
