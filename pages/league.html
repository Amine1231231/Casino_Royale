<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Casino Royale - League</title>
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body>
  <!-- Floating Particles -->
  <div class="particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>

  <!-- Header -->
  <header>
    <div class="container">
      <nav>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="user.html">User</a></li>
          <li><a href="tournament.html">Tournament</a></li>
          <li><a href="league.html" class="active">League</a></li>
          <li><a href="bet.html">Bet</a></li>
          <li><a href="results.html">Results</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- League Page Content -->
  <div class="user-container">
    <div id="messageArea"></div>

    <!-- Leagues List -->
    <div class="players-section active" id="leaguesList">
      <div class="welcome-msg">Loading leagues...</div>
    </div>

    <!-- Create League Button -->
    <button class="btn btn-primary" onclick="openCreateModal()">+ Create League</button>
  </div>

  <!-- Create League Modal -->
  <div class="league-modal hidden" id="createLeagueModal">
    <div class="form-card" style="max-width:500px;">
      <h2>Create New League</h2>

      <div class="form-group">
        <input type="text" id="leagueNameInput" placeholder="Enter league name..." required>
      </div>

      <div class="players-section">
        <h3>Select Players (minimum 3)</h3>
        <div class="players-list" id="playersSelectionList">
          Loading players...
        </div>
      </div>

      <div class="players-header">
        <button class="btn btn-primary" onclick="createLeague()">Create League</button>
        <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- League Detail Modal -->
  <div class="league-modal hidden" id="leagueDetailModal">
    <div class="form-card" style="max-width:800px;">
      <h2 id="leagueDetailTitle">League Name</h2>
      <p id="leagueDetailInfo" class="welcome-msg">League Information</p>

      <div id="roundsList" class="players-list">
        Loading rounds...
      </div>

      <div class="players-header">
        <button class="btn btn-secondary" onclick="closeLeagueDetail()">Back</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdLed222yV3Hu7JEMhTEdfm7GdQSqoZk68obU86QTHL37EKuKlYhNpT_3l8Su6KpugCw/exec";
    let allPlayers = [];
    let allLeagues = [];

    window.addEventListener('load', loadLeagues);

    async function callAPI(action, data = {}) {
      const formData = new FormData();
      formData.append('action', action);
      Object.keys(data).forEach(k => formData.append(k, data[k]));
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      return res.json();
    }

    async function loadLeagues() {
      try {
        const result = await fetch(`${SCRIPT_URL}?action=getLeagues`).then(r => r.json());
        if (result.success && result.leagues) {
          allLeagues = result.leagues;
          displayLeagues(result.leagues);
        } else {
          document.getElementById('leaguesList').innerHTML =
            '<div class="welcome-msg">No leagues found. Create your first league!</div>';
        }
      } catch (error) {
        document.getElementById('leaguesList').innerHTML =
          '<div class="message error">Error loading leagues</div>';
      }
    }

    function displayLeagues(leagues) {
      if (!leagues.length) {
        document.getElementById('leaguesList').innerHTML =
          '<div class="welcome-msg">No leagues found. Create your first league!</div>';
        return;
      }
      const html = leagues.map(league => `
        <div class="player-item" onclick="showLeagueDetail('${league.name}')">
          <div class="league-title">${league.name}</div>
          <div class="welcome-msg">
            Current Round: ${league.currentRound} | 
            Players: ${league.players.length} | 
            Total Rounds: ${league.totalRounds}
          </div>
        </div>
      `).join('');
      document.getElementById('leaguesList').innerHTML = html;
    }

    async function openCreateModal() {
      document.getElementById('createLeagueModal').classList.remove('hidden');
      await loadPlayersForSelection();
    }

    function closeCreateModal() {
      document.getElementById('createLeagueModal').classList.add('hidden');
      document.getElementById('leagueNameInput').value = '';
    }

    async function loadPlayersForSelection() {
      try {
        const result = await fetch(`${SCRIPT_URL}?action=getAllPlayers`).then(r => r.json());
        if (result.success && result.players) {
          allPlayers = result.players.sort((a, b) => a.username.localeCompare(b.username));
          document.getElementById('playersSelectionList').innerHTML =
            allPlayers.map(player => `
              <div class="player-item">
                <input type="checkbox" id="player_${player.username}" value="${player.username}">
                <label for="player_${player.username}">${player.username} (${player.clashId})</label>
              </div>
            `).join('');
        } else {
          document.getElementById('playersSelectionList').textContent = 'No players found.';
        }
      } catch {
        document.getElementById('playersSelectionList').textContent = 'Error loading players.';
      }
    }

    async function createLeague() {
      const leagueName = document.getElementById('leagueNameInput').value.trim();
      if (!leagueName) {
        showMessage('Please enter a league name', 'error');
        return;
      }
      const selectedPlayers = [...document.querySelectorAll('#playersSelectionList input:checked')].map(cb => cb.value);
      if (selectedPlayers.length < 3) {
        showMessage('Please select at least 3 players', 'error');
        return;
      }
      try {
        const result = await callAPI('createLeague', {
          leagueName,
          players: JSON.stringify(selectedPlayers)
        });
        if (result.success) {
          showMessage('League created successfully!', 'success');
          closeCreateModal();
          loadLeagues();
        } else {
          showMessage(result.message || 'Failed to create league', 'error');
        }
      } catch {
        showMessage('Connection error', 'error');
      }
    }

    async function showLeagueDetail(leagueName) {
      const league = allLeagues.find(l => l.name === leagueName);
      if (!league) return;
      document.getElementById('leagueDetailTitle').textContent = league.name;
      document.getElementById('leagueDetailInfo').textContent =
        `Current Round: ${league.currentRound} | Players: ${league.players.length}`;
      try {
        const result = await callAPI('getLeagueRounds', { leagueName });
        if (result.success && result.rounds) {
          document.getElementById('roundsList').innerHTML = result.rounds.map((round, i) => `
            <div class="player-item">
              <div class="online">${round.roundNumber || `Round ${i+1}`}</div>
              ${round.matches.map(match => `<div>${match}</div>`).join('')}
            </div>
          `).join('');
        } else {
          document.getElementById('roundsList').textContent = 'No rounds available.';
        }
      } catch {
        document.getElementById('roundsList').textContent = 'Error loading rounds.';
      }
      document.getElementById('leagueDetailModal').classList.remove('hidden');
    }

    function closeLeagueDetail() {
      document.getElementById('leagueDetailModal').classList.add('hidden');
    }

    function showMessage(message, type) {
      document.getElementById('messageArea').innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => document.getElementById('messageArea').innerHTML = '', 5000);
    }
  </script>
</body>
</html>
